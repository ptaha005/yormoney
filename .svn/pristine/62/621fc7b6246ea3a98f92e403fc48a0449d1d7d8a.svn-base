define(["knockout","jquery","ko.mapping","text!./../templates/Register2.html","vent","core"],function(e,t,n,r,i,s){var o=function(e){return e?isNaN(e.getDate())||isNaN(e.getMonth())||isNaN(e.getFullYear())?"-":e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear():"-"},u=function(e){if(e==null||e=="")return null;var t=e.split("/"),n=parseInt(t[0],10),r=parseInt(t[1],10),i=parseInt(t[2],10);return new Date(i,r,n)},a=function(t,r){var i=this;n.fromJS(t,{},i);var s=t.relationship||{id:undefined,name:"-"};i.relationship={id:e.observable(s.id),name:e.observable(s.name)},i.firstName.extend({required:!0}),i.lastName.extend({required:!0}),i.email.extend({required:!0,email:{message:"please use valid email address"},minLength:2,maxLength:80}),i.errors=e.validation.group(i),i.dateOfBirthAsDate=e.observable(u(t.dateOfBirth)),i.dateOfBirth=e.computed(function(){return o(i.dateOfBirthAsDate())}),i.accountHolderText=e.computed(function(){return i.accountHolder()?"YES":"No"})};return function(n){var o=this;o.name=e.observable(n.firstName+" "+n.lastName),o.address=e.observable(n.address||"-"),o.email=e.observable(n.email),o.members=e.observableArray(e.utils.arrayMap(n.members,function(e){return new a(e)})),o.relationshipList=e.observableArray(),t.get("/api/user/getRelationships",o.relationshipList),o.currentMember=e.observable(null),o.exit=function(){i.trigger("logout")};var u=function(){o.currentMember(new a({id:"",occupation:"",email:"",firstName:"",lastName:"",dateOfBirth:"",accountHolder:!1}))};u();var f=e.utils.arrayFirst(o.members(),function(e){return n.firstName==e.firstName()&&n.lastName==e.lastName()});f||o.currentMember(new a({id:"",occupation:n.occupation,email:n.email,firstName:n.firstName,lastName:n.lastName,dateOfBirth:n.dateOfBirth,accountHolder:!0})),o.editMember=function(e){o.currentMember(e)},o.deleteMember=function(e){s.ajax_post("/api/member/delete",{id:e.id},function(){o.members.remove(e),u()}).fail(function(){alert("can`t delete, exist bank account with this member.")})},o.memberExistError=e.observable(""),o.done=function(){i.trigger("update_state","register2")},o.save=function(){var t=e.utils.arrayFirst(o.members(),function(e){return o.currentMember().id()!=e.id()&&o.currentMember().firstName()==e.firstName()&&o.currentMember().lastName()==e.lastName()});if(t){o.memberExistError("member with this name already exist");return}o.memberExistError("");var n=e.utils.arrayFirst(o.relationshipList(),function(e){return e.id==o.currentMember().relationship.id()});n?o.currentMember().relationship.name(n.name):o.currentMember().relationship.name(undefined);if(o.currentMember().errors().length!=0){o.currentMember().errors.showAllMessages();return}var r=e.toJS(o.currentMember()),i={id:r.id,firstName:r.firstName,lastName:r.lastName,email:r.email,occupation:r.occupation,relationship:r.relationship,accountHolder:r.accountHolder,dateOfBirth:r.dateOfBirth};o.currentMember().relationship.name()==undefined&&delete i.relationship,s.ajax_post("/member/add",i,function(e){r.id==""&&o.members.push(new a(e)),u()})},o.template=r}})